<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkSpher</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <h1>WorkSpher</h1>
    <h2>Gestion du personnel</h2>
</header>

<div class="main-wrapper">
    <div class="left-panel">
        <button class="btn-gray" id="addWorker">Ajouter un employé</button>
        <div class="aaaa"></div>
    </div>
    
    <div class="right-panel">
        <div class="flex">
            <div class="div">
                <div class="article" data-zone="Réception">
                    <div class="head">
                        <h3>Réception</h3>
                        <div><p>+</p>Max: 2</div>
                    </div>
                    <div class="affecté"></div>
                </div>
                <div class="article" data-zone="conférence">
                    <div class="head">
                        <h3>Salle de conférence</h3>
                        <div><p>+</p>Max: 8</div>
                    </div>
                    <div class="affecté"></div>
                </div>
                <div class="article" data-zone="serveurs">
                    <div class="head">
                        <h3>Salle des serveurs</h3>
                        <div><p>+</p>Max: 4</div>
                    </div>
                    <div class="affecté"></div>
                </div>
            </div>
            <div class="div">
                <div class="article" data-zone="sécurité">
                    <div class="head">
                        <h3>Salle de sécurité</h3>
                        <div><p>+</p>Max: 3</div>
                    </div>
                    <div class="affecté"></div>
                </div>
                <div class="article" data-zone="personnel">
                    <div class="head">
                        <h3>Salle du personnel</h3>
                        <div><p>+</p>Max: 6</div>
                    </div>
                    <div class="affecté"></div>
                </div>
                <div class="article" data-zone="archives">
                    <div class="head">
                        <h3>Salle d'archives</h3>
                        <div><p>+</p>Max: 2</div>
                    </div>
                    <div class="affecté"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="assignModal" class="assignModal">
    <div class="assignContent">
        <h2>Choisir un employé pour <span id="roomName"></span></h2>
        <div id="availableWorkers"></div>
        <button id="assignBtn">Affecter</button>
        <button id="closeAssignModal">Annuler</button>
    </div>
</div>

<div class="modelAddWorder" id="modal">
    <form class="modal-form">
        <h1>Ajouter un employé</h1>

        <label>Nom</label>
        <input id="name" class="input-field" type="text" placeholder="Ex: Mostafa" required>

        <label>Role</label>
        <select id="role" class="input-field" required>
            <option>Réceptionniste</option>
            <option>Technicien IT</option>
            <option>Agent de sécurité</option>
            <option>Manager</option>
            <option>Nettoyage</option>
        </select>

        <label>Photo (URL)</label>
        <input id="img" class="input-field" type="text" placeholder="https://..." required>

        <label>Email</label>
        <input id="email" class="input-field" type="email" placeholder="email@exemple.com" required>

        <label>Téléphone</label>
        <input id="tele" class="input-field" type="number" placeholder="+ 212 6..." required>

        <h2>Expériences professionnelles</h2>
        <div id="cardExperience"></div>

        <button id="addexperiences" class="btn-blue">Ajouter expérience</button>
        <br><br>

        <div class="float-right">
            <button class="btn-green">Enregistrer</button>
            <button class="btn-light" type="button" id="closeModal">Annuler</button>
        </div>
    </form>
</div>

<div id="profile">
    <div class="card">
        <img class="myPhoto" src="">
        <div class="infos">
            <h2 id="nameOut"></h2>
            <p id="roleOut"></p>
            <br>
            <div class="details"><strong>Email: </strong><p id="emailOut"></p></div>
            <div class="details"><strong>Téléphone: </strong><p id="teleOut"></p></div>
            <div class="details"><strong>Expériences: </strong><p id="experienceOutPut"></p></div>
        </div>
        <button id="closeProfile">✕</button>
    </div>
</div>

<script>
let workers = JSON.parse(localStorage.getItem("workers")) || [];
let assignedWorkers = [];

const maxCapacity = {
    "Réception":2, "conférence":8, "serveurs":4, 
    "sécurité":3, "personnel":6, "archives":2
};
const autoriseRole = {
    "Réception":["Réceptionniste","Manager","Nettoyage"],
    "serveurs":["Technicien IT","Manager","Nettoyage"],
    "sécurité":["Agent de sécurité","Manager","Nettoyage"],
    "personnel":["Réceptionniste","Technicien IT","Agent de sécurité","Manager","Nettoyage"],
    "conférence":["Réceptionniste","Technicien IT","Agent de sécurité","Manager","Nettoyage","Autre"],
    "archives":["Réceptionniste","Technicien IT","Agent de sécurité","Manager","Autre"]
};

const modal = document.getElementById("modal");
const addWorkerBtn = document.getElementById("addWorker");
const closeModalBtn = document.getElementById("closeModal");
const addExperienceBtn = document.getElementById("addexperiences");
const cardExperienceContainer = document.getElementById("cardExperience");
const leftDiv = document.querySelector(".aaaa");
const profileModal = document.getElementById("profile");
const closeProfileBtn = document.getElementById("closeProfile");

const assignModal = document.getElementById("assignModal");
const availableWorkersDiv = document.getElementById("availableWorkers");
const roomNameSpan = document.getElementById("roomName");
let currentRoom = "";

function saveWorkers(){
    localStorage.setItem("workers", JSON.stringify(workers));
}

function isAuthorized(worker, roomName){
    return (autoriseRole[roomName] || []).includes(worker.role);
}

addWorkerBtn.addEventListener("click", () => modal.classList.add("show"));
closeModalBtn.addEventListener("click", () => modal.classList.remove("show"));
modal.addEventListener("click", e => { if(e.target===modal) modal.classList.remove("show"); });

addExperienceBtn.addEventListener("click", e => {
    e.preventDefault();
    const expDiv = document.createElement("div");
    expDiv.className = "experiencesContent";
    expDiv.innerHTML = `
        <div class="header-experience">
            <div><h4>Titre</h4><input class="input-field inExp" type="text" required></div>
            <div><h4>Du</h4><input class="input-field inDate1" type="date" required></div>
            <div><h4>Au</h4><input class="input-field inDate2" type="date" required></div>
        </div>
        <div class="annulbtn">
            <button class="supprimer" type="button">Supprimer</button>
        </div><br><hr>
    `;
    cardExperienceContainer.appendChild(expDiv);
});

cardExperienceContainer.addEventListener("click", e => {
    if(e.target.classList.contains("supprimer")){
        e.target.closest(".experiencesContent").remove();
    }
});

document.querySelector(".modal-form").addEventListener("submit", e=>{
    e.preventDefault();
    const name = document.getElementById('name').value;
    const role = document.getElementById('role').value;
    const img = document.getElementById('img').value;
    const email = document.getElementById('email').value;
    const tele = document.getElementById('tele').value;

    const newWorker = {
        id: Date.now(),
        name,
        role,
        img,
        email,
        tele,
        experiences: []
    };

    document.querySelectorAll('.experiencesContent').forEach(exp=>{
        newWorker.experiences.push({
            Exp: exp.querySelector('.inExp').value,
            du: exp.querySelector('.inDate1').value,
            au: exp.querySelector('.inDate2').value
        });
    });

    workers.push(newWorker);
    saveWorkers();
    modal.classList.remove("show");
    e.target.reset();
    afficheLeftPanel();
});

function afficheLeftPanel(){
    leftDiv.innerHTML = "";

    const availableWorkers= workers.filter(w=> !w.currentRoom);
    availableWorkers.forEach(w=>{
        const div = document.createElement("div");
        div.className = "staffcartLeft";
        div.innerHTML = `
            <div class="cartLeft">
                <div><img class="photo" src="${w.img}"></div>
                <div><strong>${w.name}</strong><p class="role">${w.role}</p></div>
            </div>
            <div><button class="voir" data-id="${w.id}">Voir</button></div>
        `;
        leftDiv.appendChild(div);
    });
    voirBtn()
}

function voirBtn(){
    document.querySelectorAll('.aaaa .voir').forEach(btn=>{
        btn.onclick =()=>{
            const id = parseInt(btn.dataset.id)
            const worker=workers.find(w=> w.id ===id);
            if(worker) openProfile(worker)
        }
    })
}
function openProfile(worker){
    document.getElementById('nameOut').textContent = worker.name;
    document.getElementById('roleOut').textContent = worker.role;
    document.getElementById('emailOut').textContent = worker.email;
    document.getElementById('teleOut').textContent = worker.tele;
    document.querySelector('.myPhoto').src = worker.img;
    document.getElementById('experienceOutPut').innerHTML = worker.experiences.length 
        ? worker.experiences.map(e=>` ● ${e.Exp} (${e.du} - ${e.au})`).join("<br>")
        : "Aucune expérience";
    profileModal.classList.add("show");
}
leftDiv.addEventListener("click", e => {
    if(e.target.classList.contains("voir")){
        const id = parseInt(e.target.dataset.id);
        const w = workers.find(w=>w.id===id);
        if(w) openProfile(w);
    }
});
closeProfileBtn.onclick = ()=> profileModal.classList.remove("show");
profileModal.onclick = e=>{ if(e.target===profileModal) profileModal.classList.remove("show"); }

function handleAddToZone(roomName){
    currentRoom = roomName;
    roomNameSpan.textContent = roomName;
    availableWorkersDiv.innerHTML = "";

    const availableWorkers = workers.filter(w=>isAuthorized(w, roomName) && !w.currentRoom);

    if(!availableWorkers.length){
        availableWorkersDiv.innerHTML = "<p>Aucun employé disponible pour cette salle.</p>";
        return;
    }

    availableWorkers.forEach(w=>{
        const div = document.createElement("div");
        div.className = "workerOption";
        div.innerHTML = `
            <input type="checkbox" id="worker-${w.id}" value="${w.id}">
            <label for="worker-${w.id}">${w.name} (${w.role})</label>
        `;
        availableWorkersDiv.appendChild(div);
    });

    assignModal.classList.add("show");
}

document.querySelectorAll('.article').forEach(article=>{
    article.addEventListener('click', e=>{
        if(!e.target.closest('.cardAffecte') && !e.target.classList.contains('voir')){
            handleAddToZone(article.getAttribute('data-zone'));
        }
    });
});

document.querySelector('.assignContent').addEventListener('click', e=> e.stopPropagation());
document.getElementById('assignBtn').addEventListener('click', ()=>{
    availableWorkersDiv.querySelectorAll('input[type="checkbox"]:checked').forEach(cb=>{
        const w = workers.find(w=>w.id===parseInt(cb.value));
        if(w) assignWorkerToRoom(w, currentRoom);
        afficheLeftPanel()
    });
    saveWorkers();
    assignModal.classList.remove("show");
    renderRooms();
});
document.getElementById('closeAssignModal').addEventListener('click', ()=>assignModal.classList.remove("show"));
assignModal.addEventListener('click', e=>{ if(e.target===assignModal) assignModal.classList.remove("show"); });

function createWorkerCard(worker){
    const div = document.createElement('div');
    div.className = "cardAffecte";
    div.dataset.id = worker.id;
    div.innerHTML = `
        <div class="cartLeft">
            <div><img class="photo" src="${worker.img}"></div>
            <div><strong>${worker.name}</strong><p class="role">${worker.role}</p></div>
        </div>
        <div class="ViewAnnuler">
            <button class="voir" data-id="${worker.id}">Voir</button>
            <button class="annule">✕</button>
        </div>
    `;
    div.querySelector('.voir').addEventListener('click', ()=> openProfile(worker));
    div.querySelector('.annule').addEventListener('click', ()=>{
        removeFromRoom(worker.id);
    });
    return div;
    
}

function assignWorkerToRoom(worker, roomName){
    const zone = document.querySelector(`[data-zone="${roomName}"] .affecté`);
    if(zone.querySelectorAll('.cardAffecte').length >= maxCapacity[roomName]){
        alert(`La salle "${roomName}" a atteint sa capacité maximale.`);
        return;
    }
    if(!isAuthorized(worker, roomName)){
        alert(`Le rôle "${worker.role}" n’est pas autorisé ici.`);
        return;
    }
    worker.currentRoom = roomName;
    zone.appendChild(createWorkerCard(worker));
}

function removeFromRoom(id){
    const worker = workers.find(w => w.id === id);
    if(!worker || !worker.currentRoom) return;

    const roomName = worker.currentRoom;
    const zone = document.querySelector(`[data-zone="${roomName}"] .affecté`);

    const card = zone.querySelector(`[data-id="${id}"]`);
    if(card) card.remove();

    worker.currentRoom = null;

    const index = assignedWorkers.findIndex(w=> w.id===id);
    if(index !== -1) assignedWorkers.splice(index,1);

    saveWorkers();
    afficheLeftPanel();
}

function renderRooms(){
    // clear zones
    Object.keys(maxCapacity).forEach(room=>{
        const zone = document.querySelector(`[data-zone="${room}"] .affecté`);
        zone.innerHTML = "";
    });

    // reload workers already assigned
    workers
        .filter(w => w.currentRoom)
        .forEach(w => {
            const zone = document.querySelector(`[data-zone="${w.currentRoom}"] .affecté`);
            zone.appendChild(createWorkerCard(w));
        });
}


afficheLeftPanel();
renderRooms();

</script>

</body>
</html>
